<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PW Twin Eligibility Calculator</title>
  <style>
    :root {
      --bg: #f7f8fc;
      --panel: #ffffff;
      --ink: #0a1226;
      --muted: #5b657a;
      --accent: #3a63ff;
      --good: #2ecc71;
      --bad: #e74c3c;
      --warn: #f39c12;
      --border: rgba(10,18,38,.12);
    }
    html, body { height: 100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 980px; margin: 24px auto 80px; padding: 0 16px; }
    h1 { font-size: 28px; margin: 12px 0 8px; }
    p.lead { color: var(--muted); margin-top: 0; }
    .card { background: var(--panel); border: 1px solid var(--border); box-shadow: 0 6px 24px rgba(0,0,0,.05); border-radius: 16px; padding: 18px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    /* spacing fix for name ↔ dropdowns */
    .character .row-3:first-of-type { grid-template-columns: minmax(260px,1fr) minmax(220px,1fr) minmax(220px,1fr); gap: 16px; }
    @media (max-width: 800px){ .row, .row-3 { grid-template-columns: 1fr; } }
    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #fbfcff; color: var(--ink); font-size: 15px; }
    input[type="number"] { background: #fff; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; border:1px solid var(--border); color: var(--muted); background:#f5f7ff; }
    .btn { appearance:none; border:0; background: var(--accent); color:#fff; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor:pointer; }
    .btn.subtle { background: #eef1ff; color: var(--accent); border:1px solid var(--border); }
    .btn.ghost { background: transparent; color: var(--muted); border:1px solid var(--border); }
    .btn-row { display:flex; gap: 10px; flex-wrap: wrap; }
    .character { border:1px solid var(--border); border-radius: 14px; padding: 14px; background: #ffffff; }
    .title { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 8px; }
    .status { font-weight:700; }
    .status.ok { color: var(--good); }
    .status.warn { color: var(--warn); }
    .status.bad { color: var(--bad); }
    .small { font-size: 12px; color: var(--muted); }
    .grid { display: grid; gap: 12px; }
    .footnote { color: var(--muted); font-size: 12px; }
    .result-box { padding: 12px; border-radius: 12px; border:1px solid var(--border); background: #fafbff; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hidden { display: none; }
    .ambig { color: var(--bad); font-weight: 800; }

    /* --- Padding/spacing polish --- */
    *, *::before, *::after { box-sizing: border-box; }
    /* add vertical rhythm between stacked rows inside cards */
    .card > .row + .row { margin-top: 12px; }
    .character .row + .row,
    .character .row-3 + .row-3,
    .character .row-3 + .row { margin-top: 12px; }
    /* consistent control sizing & spacing between label and control */
    label + input, label + select { margin-top: 6px; }
    input[type="text"], input[type="number"], select { min-height: 44px; line-height: 1.25; }
    /* pills tighten up vertically */
    .pill { line-height: 1; }
    /* header area spacing so status + clear don’t hug the edge */
    .character .title { padding: 2px 2px; }
    .character .title .btn-row { align-items: center; gap: 12px; }
    .character .status { margin-left: 4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PW Twin Eligibility Calculator</h1>
    <p class="lead">Quick entry. Add your characters and we will check per character minimums and the overall average. Spirits have no minimum and are included in the overall average. Enter the <strong>current term number</strong> below, and each character's <strong>joined term</strong>; we will auto-calc their <em>terms on board</em> and whether they are <em>≥ 2 real-life years</em> on PW (strict).</p>

    <div class="card" id="config">
      <div class="row">
        <div>
          <label for="globalTerm">Current term number</label>
          <input id="globalTerm" type="number" min="1" step="1" value="" placeholder="e.g., 178" />
        </div>
        <div>
          <label for="numChars">How many characters do you have?</label>
          <input id="numChars" type="number" min="1" step="1" value="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="hasSpirits">Do you have any spirit characters?</label>
          <select id="hasSpirits">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div>
          <label for="hasAdults">Do you have any adult-created characters?</label>
          <select id="hasAdults">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn" id="build">Build character inputs</button>
        <button class="btn subtle" id="demoFill">Demo data</button>
        <button class="btn ghost" id="clearAll">Clear all</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="grid" id="characters"></div>

    <div style="height:12px"></div>

    <div class="card" id="results" style="display:none;">
      <h3 style="margin:4px 0 10px;">Results</h3>
      <div class="row">
        <div class="result-box">
          <div>Total characters counted: <span class="mono" id="counted"></span></div>
          <div>Total posts per term (sum): <span class="mono" id="sumPosts"></span></div>
          <div>Overall average per character: <span class="mono" id="avgPosts"></span></div>
          <div>Required total posts this term: <span class="mono" id="requiredTotal"></span> <span class="small">(20 × characters)</span></div>
        </div>
        <div class="result-box">
          <div>Eligibility: <span id="eligibility" class="status"></span></div>
          <div class="small">Rule summary: Each character under 2 RL years must be at ≥20 posts per term. Characters ≥2 RL years must be at ≥10. Spirits have no minimum. Overall average must be ≥20.</div>
        </div>
      </div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn" id="copySummary">Copy summary</button>
      </div>
    </div>

    <p class="footnote">Notes: This tool focuses on activity math. Staff may also consider probations, deletions, first year limits, and other context that this calculator does not judge.</p>
  </div>

  <template id="charTpl">
    <div class="character" data-index="{{i}}">
      <div class="title">
        <div><span class="pill">Character {{iLabel}}</span></div>
        <div class="btn-row">
          <button class="btn ghost btn-clear-one" data-i="{{i}}">Clear</button>
          <div class="status" id="charStatus-{{i}}"></div>
        </div>
      </div>
      <div class="row-3">
        <div>
          <label for="name-{{i}}">Character name</label>
          <input type="text" id="name-{{i}}" placeholder="e.g., Jane Smith" />
        </div>
        <div class="adultCreatedField">
          <label for="adultCreated-{{i}}">Is this an adult-created character?</label>
          <select id="adultCreated-{{i}}">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div class="spiritField">
          <label for="spirit-{{i}}">Spirit character?</label>
          <select id="spirit-{{i}}">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>
      <div class="row-3">
        <div>
          <label for="joined-{{i}}">What term did they join? (number)</label>
          <input type="number" id="joined-{{i}}" min="1" step="1" placeholder="e.g., 168" />
          <div class="small">Uses the current term number above.</div>
        </div>
        <div>
          <label>Terms on board (auto)</label>
          <div id="terms-{{i}}" class="pill">—</div>
          <div class="small" style="margin-top:4px;">School/AW status</div>
          <div id="track-{{i}}" class="pill" style="margin-top:4px;">—</div>
        </div>
        <div>
          <label>2+ RL years? (auto)</label>
          <div id="rl2pill-{{i}}" class="pill">—</div>
          <div id="rl2note-{{i}}" class="small"></div>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="posts-{{i}}">Current posts per term (average)</label>
          <input type="number" id="posts-{{i}}" min="0" step="1" value="0" />
        </div>
        <div>
          <label>Minimum required for this character</label>
          <div id="minReq-{{i}}" class="pill">—</div>
        </div>
      </div>
    </div>
  </template>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // --- Timeline map (terms → start/end in UTC) ---
    const TIMELINE = {
      120:{s:'2018-04-07',e:'2018-05-18'}, 121:{s:'2018-05-19',e:'2018-06-30'}, 122:{s:'2018-07-07',e:'2018-08-17'}, 123:{s:'2018-08-18',e:'2018-09-28'}, 124:{s:'2018-09-29',e:'2018-11-23'}, 125:{s:'2018-11-24',e:'2019-01-04'}, 126:{s:'2019-01-05',e:'2019-02-15'}, 127:{s:'2019-02-16',e:'2019-03-30'}, 128:{s:'2019-04-06',e:'2019-05-17'}, 129:{s:'2019-05-18',e:'2019-06-29'}, 130:{s:'2019-07-06',e:'2019-08-16'}, 131:{s:'2019-08-17',e:'2019-09-28'}, 132:{s:'2019-10-05',e:'2019-11-15'}, 133:{s:'2019-11-16',e:'2019-12-28'}, 134:{s:'2020-01-04',e:'2020-02-14'}, 135:{s:'2020-02-15',e:'2020-03-28'}, 136:{s:'2020-04-04',e:'2020-05-15'}, 137:{s:'2020-05-16',e:'2020-06-27'}, 138:{s:'2020-07-04',e:'2020-08-14'}, 139:{s:'2020-08-15',e:'2020-09-26'}, 140:{s:'2020-10-03',e:'2020-11-13'}, 141:{s:'2020-11-14',e:'2020-12-26'}, 142:{s:'2021-01-02',e:'2021-02-12'}, 143:{s:'2021-02-13',e:'2021-03-27'}, 144:{s:'2021-04-03',e:'2021-05-13'}, 145:{s:'2021-05-14',e:'2021-06-26'}, 146:{s:'2021-07-03',e:'2021-08-13'}, 147:{s:'2021-08-14',e:'2021-09-25'}, 148:{s:'2021-10-02',e:'2021-11-13'}, 149:{s:'2021-11-20',e:'2021-12-25'}, 150:{s:'2022-01-01',e:'2022-02-11'}, 151:{s:'2022-02-12',e:'2022-03-26'}, 152:{s:'2022-04-02',e:'2022-05-13'}, 153:{s:'2022-05-14',e:'2022-06-25'}, 154:{s:'2022-07-03',e:'2022-08-12'}, 155:{s:'2022-08-13',e:'2022-09-24'}, 156:{s:'2022-10-01',e:'2022-11-11'}, 157:{s:'2022-11-12',e:'2022-12-24'}, 158:{s:'2023-01-07',e:'2023-02-17'}, 159:{s:'2023-02-18',e:'2023-04-01'}, 160:{s:'2023-04-08',e:'2023-05-19'}, 161:{s:'2023-05-20',e:'2023-07-01'}, 162:{s:'2023-07-08',e:'2023-08-18'}, 163:{s:'2023-08-19',e:'2023-09-30'}, 164:{s:'2023-10-07',e:'2023-11-17'}, 165:{s:'2023-11-18',e:'2023-12-30'}, 166:{s:'2024-01-06',e:'2024-02-23'}, 167:{s:'2024-02-24',e:'2024-04-05'}, 168:{s:'2024-04-06',e:'2024-05-17'}, 169:{s:'2024-05-18',e:'2024-06-29'}, 170:{s:'2024-07-06',e:'2024-08-16'}, 171:{s:'2024-08-17',e:'2024-09-28'}, 172:{s:'2024-10-05',e:'2024-11-15'}, 173:{s:'2024-11-16',e:'2024-12-28'}, 174:{s:'2025-01-04',e:'2025-02-14'}, 175:{s:'2025-02-15',e:'2025-03-28'}, 176:{s:'2025-04-05',e:'2025-05-16'}, 177:{s:'2025-05-17',e:'2025-06-28'}, 178:{s:'2025-07-05',e:'2025-08-15'}
    };

    const toUTC = (iso) => { const [y,m,d] = iso.split('-').map(Number); return new Date(Date.UTC(y, m-1, d)); };
    const getTerm = (n) => TIMELINE[n] ? { start: toUTC(TIMELINE[n].s), end: toUTC(TIMELINE[n].e) } : null;
    const DAYS = 24*60*60*1000;
    const TWO_YEARS = 730; // strict

    // Detect the current term from today's date (UTC) and prefill/reset when needed
    function currentTermFromToday(){
      const now = new Date();
      const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      for (const key of Object.keys(TIMELINE)){
        const t = getTerm(parseInt(key,10));
        if (t && todayUTC >= t.start && todayUTC <= t.end) return parseInt(key,10);
      }
      return null;
    }
    function autoSetCurrentTermIfEmptyOrStale(){
      const el = document.getElementById('globalTerm');
      if (!el) return;
      const detected = currentTermFromToday();
      if (detected == null) return;
      const now = new Date();
      const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      const raw = String(el.value || '').trim();
      const val = parseInt(raw, 10);
      if (!raw) { el.value = detected; return; }
      const t = getTerm(val);
      if (!t || todayUTC < t.start || todayUTC > t.end) {
        el.value = detected;
      }
    }

    function getHasSpirits(){
      const el = $('#hasSpirits');
      return el ? el.value : 'no';
    }
    function getHasAdults(){
      const el = $('#hasAdults');
      return el ? el.value : 'no';
    }

    function readEntries(){
      return $$('.character').map((wrap, i) => {
        const get = id => wrap.querySelector('#' + id + '-' + i);
        return {
          name: get('name') ? get('name').value : '',
          adultCreated: get('adultCreated') ? get('adultCreated').value : 'no',
          spirit: get('spirit') ? get('spirit').value : 'no',
          joined: get('joined') ? get('joined').value : '',
          posts: get('posts') ? get('posts').value : '0'
        };
      });
    }

    function applyEntries(entries){
      $$('.character').forEach((wrap, i) => {
        const set = (id, v) => { const el = wrap.querySelector('#' + id + '-' + i); if (el != null) el.value = v != null ? v : el.value; };
        const e = entries[i] || { name:'', adultCreated:'no', spirit:'no', joined:'', posts:'0' };
        set('name', e.name);
        set('adultCreated', e.adultCreated);
        set('spirit', e.spirit);
        set('joined', e.joined);
        set('posts', e.posts);
      });
      updateVisibility();
    }

    function buildChars() {
      const prev = readEntries();
      const n = Math.max(1, parseInt($('#numChars').value || '1', 10));
      const host = $('#characters');

      const currentCount = $$('.character').length;
      if (n > currentCount) {
        for (let i = currentCount; i < n; i++) {
          const html = $('#charTpl').innerHTML
            .replaceAll('{{i}}', i)
            .replaceAll('{{iLabel}}', i + 1);
          const node = document.createElement('div');
          node.innerHTML = html.trim();
          host.appendChild(node.firstElementChild);
        }
      } else if (n < currentCount) {
        for (let i = currentCount - 1; i >= n; i--) {
          const toRemove = host.querySelector(`.character[data-index="${i}"]`);
          if (toRemove) host.removeChild(toRemove);
        }
      }

      attachListeners();
      applyEntries(prev);
      compute();
      persist();
    }

    function updateVisibility(){
      const hasSpirits = getHasSpirits() === 'yes';
      const hasAdults = getHasAdults() === 'yes';
      $$('.character').forEach((wrap, i) => {
        const spiritWrap = wrap.querySelector('.spiritField');
        const adultCreatedWrap = wrap.querySelector('.adultCreatedField');
        if (spiritWrap) spiritWrap.classList.toggle('hidden', !hasSpirits);
        if (adultCreatedWrap) adultCreatedWrap.classList.toggle('hidden', !hasAdults);
        if (!hasSpirits) { const el = wrap.querySelector('#spirit-' + i); if (el) el.value = 'no'; }
        if (!hasAdults) { const el = wrap.querySelector('#adultCreated-' + i); if (el) el.value = 'no'; }
      });
    }

    function attachListeners(){
      $$('#characters input, #characters select').forEach(el => {
        el.oninput = () => { compute(); persist(); };
        el.onchange = () => { compute(); persist(); };
      });
      $$('.btn-clear-one').forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.getAttribute('data-i'), 10);
          clearCharacter(i);
        };
      });
      const gt = $('#globalTerm');
      if (gt) {
        gt.oninput = () => { compute(); persist(); };
        gt.onchange = () => { compute(); persist(); };
        gt.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); compute(); persist(); }});
      }
      const hs = $('#hasSpirits'); if (hs) hs.addEventListener('change', () => { updateVisibility(); compute(); persist(); });
      const ha = $('#hasAdults'); if (ha) ha.addEventListener('change', () => { updateVisibility(); compute(); persist(); });
    }

    function compute(){
      const globalTermVal = $('#globalTerm') && $('#globalTerm').value ? parseInt($('#globalTerm').value, 10) : NaN;
      const globalTerm = isFinite(globalTermVal) ? getTerm(globalTermVal) : null;
      const hasSpirits = getHasSpirits() === 'yes';
      let sum = 0;
      let counted = 0;
      let allPerCharOK = true;

      function calcTermsOnboard(joinedNum, currentNum){
        const j = parseInt(joinedNum, 10);
        const c = parseInt(currentNum, 10);
        if (!isFinite(j) || !isFinite(c) || j < 1 || c < 1) return null;
        if (c < j) return 0;
        return (c - j + 1);
      }

      function rl2Status(joinedNum){
        if (!globalTerm) return { flag: null, note: 'Set the current term to evaluate RL years.' };
        const j = parseInt(joinedNum, 10);
        if (!isFinite(j)) return { flag: null, note: '' };
        const jt = getTerm(j);
        if (!jt) return { flag: null, note: 'Unknown joined term — add to timeline.' };
        const minDays = Math.floor((globalTerm.start - jt.end) / DAYS);
        const maxDays = Math.floor((globalTerm.end - jt.start) / DAYS);
        if (minDays >= TWO_YEARS) return { flag: true, note: '≥ 2 years (certain)' };
        if (maxDays < TWO_YEARS) return { flag: false, note: 'Under 2 years (certain)' };
        return { flag: false, note: 'Could be ≥ 2 years depending on dates — please check exact dates.' };
      }

      $$('.character').forEach((wrap, i) => {
        const get = id => wrap.querySelector('#' + id + '-' + i);
        const posts = parseFloat((get('posts') && get('posts').value) ? get('posts').value : '0');
        const spiritVal = get('spirit') && get('spirit').value;
        const isSpirit = hasSpirits && spiritVal === 'yes';
        const joinedVal = get('joined') && get('joined').value;
        const acEl = wrap.querySelector('#adultCreated-' + i);
        const isAdultCreated = (getHasAdults() === 'yes') && acEl && acEl.value === 'yes';

        const terms = calcTermsOnboard(joinedVal, $('#globalTerm').value);
        const termsEl = wrap.querySelector('#terms-' + i);
        if (termsEl) termsEl.textContent = terms == null ? '—' : (terms === 0 ? '—' : String(terms));

        const rl2 = rl2Status(joinedVal);
        const rl2pill = wrap.querySelector('#rl2pill-' + i);
        const rl2note = wrap.querySelector('#rl2note-' + i);
        if (rl2pill) rl2pill.textContent = rl2.flag === null ? '—' : (rl2.flag ? 'Yes' : 'No');
        if (rl2note) {
          const isAmbig = rl2.note && rl2.note.toLowerCase().includes('could be ≥ 2 years');
          rl2note.classList.toggle('ambig', !!isAmbig);
          rl2note.innerHTML = isAmbig ? ('<strong>' + rl2.note + '</strong>') : (rl2.note || '');
        }

        let minReq = 0;
        if (isSpirit) {
          minReq = 0;
        } else if (rl2.flag) {
          minReq = 10;
        } else {
          minReq = 20;
        }

        const minEl = wrap.querySelector('#minReq-' + i);
        if (minEl) minEl.textContent = minReq === 0 ? 'No minimum (spirit)' : (minReq + '+ posts / term');
        const status = wrap.querySelector('#charStatus-' + i);
        if (status) {
          if (isSpirit) {
            status.textContent = 'OK (spirit)';
            status.className = 'status ok';
          } else if (posts >= minReq) {
            status.textContent = 'Meets per character minimum';
            status.className = 'status ok';
          } else {
            status.textContent = 'Below minimum (' + posts + ' < ' + minReq + ')';
            status.className = 'status bad';
            allPerCharOK = false;
          }
        }

        const trackEl = wrap.querySelector('#track-' + i);
        if (trackEl) {
          if (!isAdultCreated && terms != null && terms > 0) {
            if (terms > 7) {
              trackEl.textContent = 'AW terms: ' + (terms - 7);
            } else {
              trackEl.textContent = 'Hogwarts Year ' + terms;
            }
          } else {
            trackEl.textContent = '—';
          }
        }

        sum += isFinite(posts) ? posts : 0;
        counted += 1;
      });

      const avg = counted > 0 ? (sum / counted) : 0;
      const requiredTotal = counted * 20;

      $('#counted').textContent = String(counted);
      $('#sumPosts').textContent = sum.toFixed(1);
      $('#avgPosts').textContent = avg.toFixed(2);
      $('#requiredTotal').textContent = requiredTotal.toFixed(1);

      const meetsOverall = sum >= requiredTotal;
      const eligible = allPerCharOK && meetsOverall;

      const eligEl = $('#eligibility');
      if (eligible) {
        eligEl.textContent = 'Eligible (activity math passes)';
        eligEl.className = 'status ok';
      } else if (meetsOverall && !allPerCharOK) {
        eligEl.textContent = 'Overall OK, but at least one character is below its minimum';
        eligEl.className = 'status warn';
      } else if (!meetsOverall && allPerCharOK) {
        eligEl.textContent = 'Per character OK, but overall average is below 20';
        eligEl.className = 'status bad';
      } else {
        eligEl.textContent = 'Not eligible (fails per character and overall)';
        eligEl.className = 'status bad';
      }

      $('#results').style.display = 'block';
    }

    function persist(){
      const payload = {
        numChars: parseInt($('#numChars').value || '1', 10),
        currentTerm: ($('#globalTerm') && $('#globalTerm').value) ? parseInt($('#globalTerm').value, 10) : null,
        hasSpirits: getHasSpirits(),
        hasAdults: getHasAdults(),
        entries: readEntries()
      };
      localStorage.setItem('pwTwinCalc', JSON.stringify(payload));
    }

    function restore(){
      const raw = localStorage.getItem('pwTwinCalc');
      if (!raw) { buildChars(); return; }
      try {
        const data = JSON.parse(raw);
        $('#numChars').value = data.numChars || 1;
        if (data.currentTerm) $('#globalTerm').value = data.currentTerm;
        if (data.hasSpirits) { const el = $('#hasSpirits'); if (el) el.value = data.hasSpirits; }
        if (data.hasAdults) { const el = $('#hasAdults'); if (el) el.value = data.hasAdults; }
        const host = $('#characters');
        host.innerHTML = '';
        for (let i = 0; i < (data.numChars || 1); i++) {
          const html = $('#charTpl').innerHTML
            .replaceAll('{{i}}', i)
            .replaceAll('{{iLabel}}', i + 1);
          const node = document.createElement('div');
          node.innerHTML = html.trim();
          host.appendChild(node.firstElementChild);
        }
        attachListeners();
        if (Array.isArray(data.entries)) {
          applyEntries(data.entries);
        }
        updateVisibility();
        compute();
      } catch (e) {
        buildChars();
      }
    }

    function copySummary(){
      const currentTerm = ($('#globalTerm') && $('#globalTerm').value) ? $('#globalTerm').value : '';
      const hasSpirits = getHasSpirits() === 'yes';
      const hasAdults = getHasAdults() === 'yes';
      const rows = $$('.character').map((wrap, i) => {
        const get = id => wrap.querySelector('#' + id + '-' + i);
        const name = (get('name') && get('name').value) ? get('name').value : ('Character ' + (i+1));
        const posts = (get('posts') && get('posts').value) ? get('posts').value : '0';
        const spiritTag = hasSpirits && get('spirit') && get('spirit').value === 'yes' ? ' (spirit)' : '';
        const adultCreatedTag = hasAdults && get('adultCreated') && get('adultCreated').value === 'yes' ? ' (adult-created)' : '';
        const rl2txt = (wrap.querySelector('#rl2pill-' + i) || {textContent:'—'}).textContent;
        const rlnote = (wrap.querySelector('#rl2note-' + i) || {textContent:''}).textContent;
        const terms = (wrap.querySelector('#terms-' + i) || {textContent:'—'}).textContent;
        const status = (wrap.querySelector('#charStatus-' + i) || {textContent:''}).textContent;
        const min = (wrap.querySelector('#minReq-' + i) || {textContent:''}).textContent;
        return '• ' + name + adultCreatedTag + spiritTag + ': ' + posts + ' posts/term — ' + min + ' — ' + status + ' — 2+ RL yrs: ' + rl2txt + (rlnote ? ' [' + rlnote + ']' : '') + ' — Terms on board: ' + terms;
      });
      const counted = $('#counted').textContent;
      const sum = $('#sumPosts').textContent;
      const avg = $('#avgPosts').textContent;
      const req = $('#requiredTotal').textContent;
      const elig = $('#eligibility').textContent;
      const txt = `PW Twin Eligibility — Activity Summary\nCurrent term: ${currentTerm}\n\n${rows.join('\n')}\n\nCounted characters: ${counted}\nTotal posts (sum): ${sum}\nOverall average: ${avg}\nRequired total (20 × counted): ${req}\nEligibility: ${elig}`;
      navigator.clipboard.writeText(txt).then(() => {
        alert('Summary copied to clipboard');
      });
    }

    function demoFill(){
      $('#globalTerm').value = 170;
      $('#hasSpirits').value = 'yes';
      $('#hasAdults').value = 'yes';
      $('#numChars').value = 3;
      buildChars();
      const data = [
        { name:'John Smith', adultCreated:'no', spirit:'no', joined:'168', posts: '40' },
        { name:'Josh Smythe', adultCreated:'yes', spirit:'no', joined:'155', posts:'30' },
        { name:'Jack Smithson', adultCreated:'yes', spirit:'yes', joined:'150', posts:'20' }
      ];
      applyEntries(data);
      updateVisibility();
      compute();
      persist();
    }

    function clearCharacter(i){
      const wrap = document.querySelector(`.character[data-index="${i}"]`);
      if (!wrap) return;
      const set = (id, v) => { const el = wrap.querySelector('#' + id + '-' + i); if (el) el.value = v; };
      set('name', '');
      set('adultCreated', 'no');
      set('spirit', 'no');
      set('joined', '');
      set('posts', '0');
      const termsEl = wrap.querySelector('#terms-' + i);
      if (termsEl) termsEl.textContent = '—';
      const rl2pill = wrap.querySelector('#rl2pill-' + i); if (rl2pill) rl2pill.textContent = '—';
      const rl2note = wrap.querySelector('#rl2note-' + i); if (rl2note) rl2note.textContent = '';
      const trackEl = wrap.querySelector('#track-' + i); if (trackEl) trackEl.textContent = '—';
      compute();
      persist();
    }

    function clearAll(){
      $$('.character').forEach((_, i) => clearCharacter(i));
      const hs = $('#hasSpirits'); if (hs) hs.value = 'no';
      const ha = $('#hasAdults'); if (ha) ha.value = 'no';
      const gt = $('#globalTerm');
      const det = currentTermFromToday();
      if (gt && det != null) gt.value = det; // reset to current term by date
      updateVisibility();
      compute();
      persist();
    }

    // Non-mutating smoke tests (run only if URL hash contains #selftest)
    function runSelfTests(){
      try {
        console.group('SelfTests');
        console.assert(typeof currentTermFromToday === 'function', 'currentTermFromToday exists');
        console.assert(typeof getTerm(178) === 'object' || getTerm(178) === null, 'getTerm returns object/null');
        console.assert(['a','b'].join('\n') === 'a\nb', 'newline join works');
        console.groupEnd();
      } catch (e) { console.warn('SelfTests error', e); }
    }

    // Hook up top buttons
    $('#build').addEventListener('click', buildChars);
    $('#demoFill').addEventListener('click', demoFill);
    $('#clearAll').addEventListener('click', clearAll);
    $('#copySummary').addEventListener('click', copySummary);
    $('#numChars').addEventListener('change', buildChars);
    $('#numChars').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); buildChars(); }});

    // initial
    (function init(){
      try { restore(); } catch(_) { buildChars(); }
      // If nothing set, default the current term to the one containing today's date
      autoSetCurrentTermIfEmptyOrStale();
      compute();
      persist();
      if (location.hash.includes('selftest')) runSelfTests();
    })();
  </script>
</body>
</html>
